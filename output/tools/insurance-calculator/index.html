<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>生命保険必要額シミュレーター【無料】必要保障額を自動計算</title>
<meta name="description" content="生命保険の必要保障額を無料でシミュレーション。年齢・家族構成・年収・貯蓄を入力するだけで、遺族の生活費・教育費・住居費から遺族年金・貯蓄を差し引いた必要保障額を瞬時に計算。グラフで内訳を可視化できます。">
<meta name="keywords" content="生命保険,必要保障額,シミュレーション,保険計算,遺族年金,教育費,生活費,保険相談">
<meta property="og:title" content="生命保険必要額シミュレーター【無料】必要保障額を自動計算">
<meta property="og:description" content="年齢・家族構成・年収・貯蓄を入力するだけで必要保障額を瞬時に計算。遺族の生活費・教育費・住居費の内訳と遺族年金・貯蓄のカバー額をグラフで可視化。無料の生命保険シミュレーターです。">
<meta property="og:type" content="website">
<meta property="og:locale" content="ja_JP">
<meta property="og:site_name" content="生命保険必要額シミュレーター">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="生命保険必要額シミュレーター【無料】必要保障額を自動計算">
<meta name="twitter:description" content="年齢・家族構成・年収・貯蓄を入力するだけで必要保障額を瞬時に計算。無料の生命保険シミュレーター。">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --green:#2e7d32;--green-light:#43a047;--green-pale:#e8f5e9;--green-dark:#1b5e20;
  --navy:#1a3a5c;--navy-light:#2c5282;--navy-pale:#e3edf7;--navy-dark:#0f2440;
  --shadow:0 2px 12px rgba(0,0,0,.08);--shadow-lg:0 4px 24px rgba(0,0,0,.12);
  --radius:12px;--gray:#f7f8fa;--text:#333;--text-light:#666;--border:#e0e0e0
}
html{font-size:16px;scroll-behavior:smooth}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:#fff;color:var(--text);line-height:1.7;min-height:100vh}
a{color:var(--green);text-decoration:none}

/* Header */
.header{background:linear-gradient(135deg,var(--navy-dark),var(--navy),var(--green-dark));color:#fff;text-align:center;padding:2.2rem 1rem 2rem;position:relative;overflow:hidden}
.header::before{content:"";position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 30% 70%,rgba(46,125,50,.15),transparent 50%);pointer-events:none}
.header h1{font-size:1.6rem;font-weight:700;margin-bottom:.4rem;position:relative}
.header p{font-size:.9rem;opacity:.88;position:relative}

/* Container */
.container{max-width:960px;margin:0 auto;padding:0 1rem 2.5rem}

/* Card */
.card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:1.5rem;margin-top:1.5rem}
.card-title{font-size:1.1rem;font-weight:700;color:var(--navy);margin-bottom:1.2rem;padding-bottom:.6rem;border-bottom:2px solid var(--navy-pale);display:flex;align-items:center;gap:.5rem}
.card-title::before{content:"";display:inline-block;width:4px;height:1.1rem;background:var(--green);border-radius:2px}
.card-title.green-title{color:var(--green-dark);border-bottom-color:var(--green-pale)}

/* Input Group */
.input-group{margin-bottom:1.3rem}
.input-group:last-child{margin-bottom:0}
.input-label{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:.5rem;font-weight:600;font-size:.93rem}
.input-label .unit{font-weight:400;color:var(--text-light);font-size:.83rem}
.slider-row{display:flex;align-items:center;gap:.75rem}
.slider-row input[type=range]{flex:1;-webkit-appearance:none;appearance:none;height:6px;border-radius:3px;background:var(--border);outline:none;cursor:pointer}
.slider-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:22px;height:22px;border-radius:50%;background:var(--green);cursor:pointer;border:3px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.slider-row input[type=range]::-moz-range-thumb{width:22px;height:22px;border-radius:50%;background:var(--green);cursor:pointer;border:3px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.slider-row .num-input{width:100px;padding:.45rem .5rem;border:1.5px solid var(--border);border-radius:8px;font-size:1rem;text-align:right;font-family:inherit;transition:border-color .2s}
.slider-row .num-input:focus{outline:none;border-color:var(--green)}

/* Select */
select.form-select{width:100%;padding:.55rem .7rem;border:1.5px solid var(--border);border-radius:8px;font-size:.95rem;font-family:inherit;background:#fff;cursor:pointer;transition:border-color .2s}
select.form-select:focus{outline:none;border-color:var(--green)}

/* Radio */
.radio-group{display:flex;gap:.65rem;margin-top:.3rem;flex-wrap:wrap}
.radio-group label{flex:1;min-width:120px;display:flex;align-items:center;justify-content:center;gap:.4rem;padding:.6rem .8rem;border:2px solid var(--border);border-radius:8px;cursor:pointer;font-weight:600;font-size:.88rem;transition:all .2s;text-align:center}
.radio-group label:has(input:checked){border-color:var(--green);background:var(--green-pale);color:var(--green-dark)}
.radio-group input{display:none}

/* Checkbox style */
.check-row{display:flex;align-items:center;gap:.5rem;margin-top:.4rem}
.check-row input[type=checkbox]{width:18px;height:18px;accent-color:var(--green);cursor:pointer}
.check-row label{cursor:pointer;font-size:.93rem}

/* Children section */
.children-section{background:var(--gray);border-radius:8px;padding:1rem;margin-top:.8rem}
.child-row{display:flex;align-items:center;gap:.6rem;margin-bottom:.6rem;flex-wrap:wrap}
.child-row:last-child{margin-bottom:0}
.child-row span{font-weight:600;font-size:.9rem;min-width:60px}
.child-row select{padding:.4rem .5rem;border:1.5px solid var(--border);border-radius:6px;font-size:.9rem;font-family:inherit}
.child-row .edu-label{font-size:.82rem;color:var(--text-light);margin-left:.3rem}

/* Two column */
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media(max-width:640px){.two-col{grid-template-columns:1fr}}

/* Result boxes */
.results-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem}
@media(max-width:500px){.results-grid{grid-template-columns:1fr}}
.result-box{background:var(--green-pale);border-radius:10px;padding:1rem;text-align:center}
.result-box.primary{background:linear-gradient(135deg,var(--navy),var(--green-dark));color:#fff;grid-column:1/-1}
.result-box.navy{background:var(--navy-pale)}
.result-box .label{font-size:.78rem;font-weight:600;margin-bottom:.25rem}
.result-box.primary .label{opacity:.9;font-size:.85rem}
.result-box .value{font-size:1.5rem;font-weight:800;letter-spacing:.02em}
.result-box.primary .value{font-size:2rem}
.result-box .sub{font-size:.75rem;opacity:.7;margin-top:.15rem}

/* Detail table */
.detail-table{width:100%;border-collapse:collapse;margin-top:.8rem;font-size:.9rem}
.detail-table th,.detail-table td{padding:.6rem .8rem;text-align:left;border-bottom:1px solid var(--border)}
.detail-table th{background:var(--gray);font-weight:600;color:var(--navy);font-size:.83rem}
.detail-table td:last-child{text-align:right;font-weight:600;white-space:nowrap}
.detail-table tr.total-row{background:var(--green-pale);font-weight:700}
.detail-table tr.total-row td{border-bottom:2px solid var(--green)}
.detail-table tr.minus td{color:#c62828}

/* Canvas */
.chart-container{margin-top:1rem;display:flex;gap:1rem;flex-wrap:wrap;justify-content:center}
.chart-wrap{flex:1;min-width:280px;max-width:420px;text-align:center}
.chart-wrap h3{font-size:.92rem;font-weight:700;color:var(--navy);margin-bottom:.5rem}
.chart-wrap canvas{width:100%;max-width:400px}

/* CTA */
.cta-box{display:block;background:linear-gradient(135deg,var(--green),var(--green-light));color:#fff;text-align:center;padding:1.1rem 1.5rem;border-radius:var(--radius);font-weight:700;font-size:1.05rem;text-decoration:none;transition:transform .15s,box-shadow .15s;box-shadow:var(--shadow)}
.cta-box:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
.cta-box.navy-cta{background:linear-gradient(135deg,var(--navy),var(--navy-light))}
.cta-box small{display:block;font-weight:400;font-size:.78rem;opacity:.9;margin-top:.2rem}

/* Note */
.note{background:#fff8e1;border:1px solid #ffe082;border-radius:8px;padding:.8rem 1rem;font-size:.82rem;color:#795548;margin-top:1.5rem;line-height:1.6}
.note strong{color:#e65100}

/* Footer */
.footer{text-align:center;padding:1.5rem 1rem;font-size:.78rem;color:var(--text-light);border-top:1px solid var(--border);margin-top:2rem}

/* Tooltip */
.tip{display:inline-block;width:16px;height:16px;background:var(--navy-pale);color:var(--navy);border-radius:50%;font-size:.7rem;line-height:16px;text-align:center;cursor:help;font-weight:700;margin-left:.3rem;position:relative}
.tip:hover::after{content:attr(data-tip);position:absolute;left:50%;bottom:calc(100% + 6px);transform:translateX(-50%);background:var(--navy);color:#fff;font-size:.75rem;font-weight:400;white-space:nowrap;padding:.35rem .6rem;border-radius:6px;z-index:10;max-width:260px;white-space:normal;line-height:1.4}
@media(max-width:500px){.tip:hover::after{left:0;transform:none;max-width:200px}}
</style>
<style>.related-tools{background:#f8f9fa;border-radius:12px;padding:20px;margin:20px 0}.related-tools h3{font-size:1rem;color:#1a2744;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #667eea}.related-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}.related-link{display:block;padding:10px 14px;background:#fff;border-radius:8px;text-decoration:none;color:#333;font-size:.9rem;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,.08);transition:transform .15s,box-shadow .15s}.related-link:hover{transform:translateY(-1px);box-shadow:0 3px 8px rgba(102,126,234,.2);color:#667eea}</style>
</head>
<body>

<div class="header">
  <h1>生命保険 必要額シミュレーター</h1>
  <p>あなたの家族に必要な保障額をすぐに計算できます</p>
</div>

<div class="container">

  <!-- Input: Basic Info -->
  <div class="card">
    <div class="card-title">基本情報</div>
    <div class="two-col">
      <div class="input-group">
        <div class="input-label">あなたの年齢<span class="unit">歳</span></div>
        <div class="slider-row">
          <input type="range" id="ageSlider" min="20" max="70" value="35">
          <input type="number" class="num-input" id="ageNum" min="20" max="70" value="35">
        </div>
      </div>
      <div class="input-group">
        <div class="input-label">年収（税込）<span class="unit">万円</span></div>
        <div class="slider-row">
          <input type="range" id="incomeSlider" min="100" max="3000" step="10" value="500">
          <input type="number" class="num-input" id="incomeNum" min="100" max="3000" step="10" value="500">
        </div>
      </div>
    </div>
    <div class="two-col">
      <div class="input-group">
        <div class="input-label">月々の生活費<span class="unit">万円</span></div>
        <div class="slider-row">
          <input type="range" id="livingSlider" min="5" max="80" step="1" value="25">
          <input type="number" class="num-input" id="livingNum" min="5" max="80" step="1" value="25">
        </div>
      </div>
      <div class="input-group">
        <div class="input-label">現在の貯蓄額<span class="unit">万円</span></div>
        <div class="slider-row">
          <input type="range" id="savingsSlider" min="0" max="10000" step="50" value="500">
          <input type="number" class="num-input" id="savingsNum" min="0" max="10000" step="50" value="500">
        </div>
      </div>
    </div>
    <div class="two-col">
      <div class="input-group">
        <div class="input-label">退職金の見込み<span class="unit">万円</span><span class="tip" data-tip="勤務先から支給される退職金の予想額。不明な場合は0でOK。">?</span></div>
        <div class="slider-row">
          <input type="range" id="retirementSlider" min="0" max="5000" step="50" value="500">
          <input type="number" class="num-input" id="retirementNum" min="0" max="5000" step="50" value="500">
        </div>
      </div>
      <div class="input-group">
        <div class="input-label">配偶者</div>
        <div class="radio-group">
          <label><input type="radio" name="spouse" value="1" checked>いる</label>
          <label><input type="radio" name="spouse" value="0">いない</label>
        </div>
      </div>
    </div>
  </div>

  <!-- Input: Housing -->
  <div class="card">
    <div class="card-title">住居情報</div>
    <div class="two-col">
      <div class="input-group">
        <div class="input-label">住居タイプ</div>
        <div class="radio-group">
          <label><input type="radio" name="housing" value="own" checked>持ち家</label>
          <label><input type="radio" name="housing" value="rent">賃貸</label>
        </div>
      </div>
      <div class="input-group" id="loanGroup">
        <div class="input-label">住宅ローン</div>
        <div class="radio-group">
          <label><input type="radio" name="loan" value="1" checked>あり（団信加入）</label>
          <label><input type="radio" name="loan" value="0">なし</label>
        </div>
      </div>
    </div>
    <div id="rentGroup" style="display:none">
      <div class="input-group">
        <div class="input-label">月額家賃<span class="unit">万円</span></div>
        <div class="slider-row">
          <input type="range" id="rentSlider" min="3" max="30" step="0.5" value="8">
          <input type="number" class="num-input" id="rentNum" min="3" max="30" step="0.5" value="8">
        </div>
      </div>
    </div>
  </div>

  <!-- Input: Children -->
  <div class="card">
    <div class="card-title">子供の情報</div>
    <div class="input-group">
      <div class="input-label">子供の人数<span class="unit">人</span></div>
      <div class="slider-row">
        <input type="range" id="childrenSlider" min="0" max="5" value="1">
        <input type="number" class="num-input" id="childrenNum" min="0" max="5" value="1">
      </div>
    </div>
    <div id="childrenDetails" class="children-section">
      <div class="child-row" data-child="0">
        <span>第1子</span>
        <select class="child-age" data-index="0">
          <option value="0">0歳</option><option value="1">1歳</option><option value="2">2歳</option>
          <option value="3" selected>3歳</option><option value="4">4歳</option><option value="5">5歳</option>
          <option value="6">6歳</option><option value="7">7歳</option><option value="8">8歳</option>
          <option value="9">9歳</option><option value="10">10歳</option><option value="11">11歳</option>
          <option value="12">12歳</option><option value="13">13歳</option><option value="14">14歳</option>
          <option value="15">15歳</option><option value="16">16歳</option><option value="17">17歳</option>
          <option value="18">18歳</option>
        </select>
        <span class="edu-label">歳</span>
        <select class="child-edu" data-index="0">
          <option value="public">全て公立</option>
          <option value="mix" selected>公立+私大</option>
          <option value="private">全て私立</option>
        </select>
      </div>
    </div>
  </div>

  <!-- CTA 1 -->
  <a href="https://fp-moneydoctor.com/" class="cta-box" style="margin-top:1.5rem;display:block" target="_blank" rel="nofollow noopener">
    お金と保険の無料相談【マネードクター】
    <small>FPに何度でも無料相談OK / オンライン対応 / 全国出張可能</small>
  </a>

  <!-- Results -->
  <div class="card" id="resultsCard">
    <div class="card-title green-title">計算結果</div>
    <div class="results-grid">
      <div class="result-box primary">
        <div class="label">必要保障額（不足額）</div>
        <div class="value" id="resultTotal">--</div>
        <div class="sub">万が一の際に追加で必要な金額</div>
      </div>
      <div class="result-box">
        <div class="label">必要資金 合計</div>
        <div class="value" id="resultNeed">--</div>
      </div>
      <div class="result-box navy">
        <div class="label">カバー済み資金</div>
        <div class="value" id="resultCover">--</div>
      </div>
    </div>

    <!-- Detail Table -->
    <table class="detail-table" id="detailTable">
      <thead><tr><th>項目</th><th>金額（万円）</th></tr></thead>
      <tbody id="detailBody"></tbody>
    </table>
  </div>

  <!-- Charts -->
  <div class="card">
    <div class="card-title green-title">グラフで見る</div>
    <div class="chart-container">
      <div class="chart-wrap">
        <h3>必要資金の内訳（棒グラフ）</h3>
        <canvas id="barChart" width="400" height="300"></canvas>
      </div>
      <div class="chart-wrap">
        <h3>カバー率（円グラフ）</h3>
        <canvas id="pieChart" width="300" height="300"></canvas>
      </div>
    </div>
  </div>

  <!-- CTA 2 -->
  <a href="https://fp-moneydoctor.com/" class="cta-box navy-cta" style="margin-top:1.5rem;display:block">
    保険の見直し相談【保険見直しラボ】
    <small>約37社の保険商品から最適プランをご提案 / 何度でも無料</small>
  </a>

  <!-- Note -->
  <div class="note">
    <strong>ご注意：</strong>この計算は概算です。正確な情報は専門家にご相談ください。遺族年金の金額は加入状況や家族構成により異なります。教育費は文部科学省「子供の学習費調査」等を参考にした概算値です。実際の必要保障額は個人の状況によって大きく変わる場合があります。
  </div>

  <div class="footer">&copy; 2025 生命保険必要額シミュレーター</div>

  <div class="related-tools">
    <h3>関連ツール</h3>
    <div class="related-grid">
    <a href="https://ai-money-lab.github.io/benri-tools/pension-calculator/" class="related-link">年金受給額シミュレーター</a>
    <a href="https://ai-money-lab.github.io/benri-tools/retirement-fund/" class="related-link">老後資金シミュレーター</a>
    <a href="https://ai-money-lab.github.io/benri-tools/salary-calculator/" class="related-link">年収手取り計算機</a>
    <a href="https://ai-money-lab.github.io/benri-tools/loan-calculator/" class="related-link">住宅ローン計算機</a>
    </div>
  </div>
</div>

<script>
(function(){
'use strict';

/* ===== Slider <-> Number sync ===== */
function syncPair(sliderId, numId){
  var s=document.getElementById(sliderId),n=document.getElementById(numId);
  s.addEventListener('input',function(){n.value=s.value;calc()});
  n.addEventListener('input',function(){
    var v=parseFloat(n.value);
    if(isNaN(v))return;
    v=Math.max(parseFloat(s.min),Math.min(parseFloat(s.max),v));
    s.value=v;n.value=v;calc();
  });
}
syncPair('ageSlider','ageNum');
syncPair('incomeSlider','incomeNum');
syncPair('livingSlider','livingNum');
syncPair('savingsSlider','savingsNum');
syncPair('retirementSlider','retirementNum');
syncPair('childrenSlider','childrenNum');
syncPair('rentSlider','rentNum');

/* ===== Radio listeners ===== */
document.querySelectorAll('input[name=spouse],input[name=housing],input[name=loan]').forEach(function(r){
  r.addEventListener('change',function(){
    toggleHousingUI();
    calc();
  });
});

function toggleHousingUI(){
  var isRent=getRadio('housing')==='rent';
  document.getElementById('rentGroup').style.display=isRent?'block':'none';
  document.getElementById('loanGroup').style.display=isRent?'none':'block';
}

function getRadio(name){
  var el=document.querySelector('input[name='+name+']:checked');
  return el?el.value:'';
}

/* ===== Children UI ===== */
var childrenSlider=document.getElementById('childrenSlider');
var childrenNum=document.getElementById('childrenNum');
var childrenDetails=document.getElementById('childrenDetails');

function buildChildrenUI(){
  var n=parseInt(childrenNum.value)||0;
  childrenDetails.style.display=n>0?'block':'none';
  var html='';
  for(var i=0;i<n;i++){
    var ordinal=['第1子','第2子','第3子','第4子','第5子'][i]||('子'+(i+1));
    var prevAge=3,prevEdu='mix';
    var existing=childrenDetails.querySelector('[data-child="'+i+'"]');
    if(existing){
      var ageSelect=existing.querySelector('.child-age');
      var eduSelect=existing.querySelector('.child-edu');
      if(ageSelect)prevAge=ageSelect.value;
      if(eduSelect)prevEdu=eduSelect.value;
    }
    html+='<div class="child-row" data-child="'+i+'">';
    html+='<span>'+ordinal+'</span>';
    html+='<select class="child-age" data-index="'+i+'">';
    for(var a=0;a<=18;a++){
      html+='<option value="'+a+'"'+(a==prevAge?' selected':'')+'>'+a+'歳</option>';
    }
    html+='</select>';
    html+='<span class="edu-label">歳</span>';
    html+='<select class="child-edu" data-index="'+i+'">';
    html+='<option value="public"'+(prevEdu==='public'?' selected':'')+'>全て公立</option>';
    html+='<option value="mix"'+(prevEdu==='mix'?' selected':'')+'>公立+私大</option>';
    html+='<option value="private"'+(prevEdu==='private'?' selected':'')+'>全て私立</option>';
    html+='</select>';
    html+='</div>';
  }
  childrenDetails.innerHTML=html;
  childrenDetails.querySelectorAll('select').forEach(function(sel){
    sel.addEventListener('change',calc);
  });
}

childrenSlider.addEventListener('input',function(){childrenNum.value=childrenSlider.value;buildChildrenUI();calc()});
childrenNum.addEventListener('input',function(){
  var v=Math.max(0,Math.min(5,parseInt(childrenNum.value)||0));
  childrenSlider.value=v;childrenNum.value=v;buildChildrenUI();calc();
});
buildChildrenUI();

/* ===== Education cost model (total remaining cost by child age) ===== */
// public: ~1000万, mix(public school + private univ): ~1400万, private: ~2000万
// We model the *remaining* cost from current age to 22 as total*(22-age)/22
function getEduCost(age, edu){
  var total=1400; // default mix
  if(edu==='public') total=1000;
  else if(edu==='private') total=2000;
  var remaining = Math.max(0, 22 - age);
  // Weight: more cost in later years (university is expensive)
  // Simple model: 30% of cost is for ages 0-14 (15 years), 70% is for ages 15-22 (7 years)
  if(age >= 22) return 0;
  if(age >= 15){
    return Math.round(total * 0.7 * (22 - age) / 7);
  } else {
    var earlyPart = total * 0.3 * Math.max(0, 15 - age) / 15;
    var latePart = total * 0.7;
    return Math.round(earlyPart + latePart);
  }
}

/* ===== Survivors pension (遺族年金) rough estimate ===== */
// 遺族基礎年金: ~780,000 + 子の加算(1-2人目:各224,000, 3人目~:各75,000) per year
// 遺族厚生年金: roughly income*0.005481*months/1000 simplified -> we use ~income*0.25 factor very roughly
// Duration: until spouse is 65 (base) or youngest child is 18 (基礎)
function calcSurvivorsPension(age, income, hasSpouse, children){
  if(!hasSpouse && children.length===0) return 0;

  var spouseAge = Math.max(25, age - 2); // rough assumption
  var yearsToSpouse65 = Math.max(0, 65 - spouseAge);

  // 遺族基礎年金 (only while children under 18)
  var youngestChildAge = 99;
  children.forEach(function(c){ if(c.age < youngestChildAge) youngestChildAge = c.age; });
  var yearsBasic = children.length > 0 ? Math.max(0, 18 - youngestChildAge) : 0;

  var basicAnnual = 0;
  if(yearsBasic > 0 && (hasSpouse || children.length > 0)){
    basicAnnual = 78; // ~78万/年
    for(var i=0; i<children.length; i++){
      if(i < 2) basicAnnual += 22.4; // ~22.4万
      else basicAnnual += 7.5;
    }
  }
  var basicTotal = Math.round(basicAnnual * yearsBasic);

  // 遺族厚生年金 (rough: income * factor, payable until spouse 65 or remarriage)
  // Very rough: about 40-50万/year for average income
  var kosei = 0;
  if(hasSpouse){
    var koseiAnnual = Math.round(income * 0.08); // rough 8% of income
    koseiAnnual = Math.max(20, Math.min(koseiAnnual, 120)); // clamp
    kosei = koseiAnnual * yearsToSpouse65;

    // 中高齢寡婦加算 (after children grow, until spouse 65): ~58万/year
    var yearsChuka = Math.max(0, yearsToSpouse65 - yearsBasic);
    if(yearsChuka > 0){
      kosei += 58 * Math.min(yearsChuka, 20);
    }
  }

  return Math.round(basicTotal + kosei);
}

/* ===== Main Calculation ===== */
var lastResult = {};

function calc(){
  var age = parseInt(document.getElementById('ageNum').value) || 35;
  var income = parseInt(document.getElementById('incomeNum').value) || 500;
  var living = parseFloat(document.getElementById('livingNum').value) || 25;
  var savings = parseInt(document.getElementById('savingsNum').value) || 0;
  var retirement = parseInt(document.getElementById('retirementNum').value) || 0;
  var hasSpouse = getRadio('spouse') === '1';
  var housingType = getRadio('housing');
  var hasLoan = getRadio('loan') === '1';
  var rent = parseFloat(document.getElementById('rentNum').value) || 8;
  var childCount = parseInt(document.getElementById('childrenNum').value) || 0;

  // Gather children info
  var children = [];
  for(var i=0; i<childCount; i++){
    var ageSel = childrenDetails.querySelector('.child-age[data-index="'+i+'"]');
    var eduSel = childrenDetails.querySelector('.child-edu[data-index="'+i+'"]');
    if(ageSel && eduSel){
      children.push({age: parseInt(ageSel.value), edu: eduSel.value});
    }
  }

  // ---- NEEDS ----
  // 1. 遺族生活費: 現在の生活費 * 0.7 * 残り年数
  // 残り年数: until spouse is average life expectancy (87 for women)
  var spouseLifeYears = hasSpouse ? Math.max(0, 87 - (age - 2)) : 0; // spouse assumed ~2yr younger
  if(!hasSpouse && childCount > 0){
    // Single parent: need living cost until youngest child is 22
    var youngestAge = 18;
    children.forEach(function(c){ if(c.age < youngestAge) youngestAge = c.age; });
    spouseLifeYears = Math.max(0, 22 - youngestAge);
  }
  var livingNeed = Math.round(living * 12 * 0.7 * spouseLifeYears); // 万円

  // 2. 教育費
  var eduNeed = 0;
  children.forEach(function(c){
    eduNeed += getEduCost(c.age, c.edu);
  });

  // 3. 住居費
  var housingNeed = 0;
  if(housingType === 'rent'){
    // Rent for remaining years
    housingNeed = Math.round(rent * 12 * Math.max(0, spouseLifeYears));
  } else if(housingType === 'own' && !hasLoan){
    // Own house, no loan remaining -> just maintenance ~15万/year
    housingNeed = Math.round(15 * Math.max(0, spouseLifeYears));
  } else {
    // Own house with loan + 団信 -> loan is covered, just maintenance
    housingNeed = Math.round(10 * Math.max(0, spouseLifeYears));
  }

  // 4. 葬儀費用
  var funeralNeed = 200;

  var totalNeed = livingNeed + eduNeed + housingNeed + funeralNeed;

  // ---- COVERAGE ----
  // 1. 遺族年金
  var pension = calcSurvivorsPension(age, income, hasSpouse, children);

  // 2. 貯蓄
  var savingsCover = savings;

  // 3. 退職金（死亡退職金）
  var retirementCover = retirement;

  var totalCover = pension + savingsCover + retirementCover;

  // ---- GAP ----
  var gap = Math.max(0, totalNeed - totalCover);

  lastResult = {
    livingNeed: livingNeed,
    eduNeed: eduNeed,
    housingNeed: housingNeed,
    funeralNeed: funeralNeed,
    totalNeed: totalNeed,
    pension: pension,
    savingsCover: savingsCover,
    retirementCover: retirementCover,
    totalCover: totalCover,
    gap: gap
  };

  // Update UI
  document.getElementById('resultTotal').textContent = formatMoney(gap);
  document.getElementById('resultNeed').textContent = formatMoney(totalNeed);
  document.getElementById('resultCover').textContent = formatMoney(totalCover);

  // Detail table
  var tbody = document.getElementById('detailBody');
  tbody.innerHTML = '' +
    row('遺族の生活費', livingNeed, '') +
    row('教育費', eduNeed, '') +
    row('住居費', housingNeed, '') +
    row('葬儀費用', funeralNeed, '') +
    row('必要資金 合計', totalNeed, 'total-row') +
    row('遺族年金（概算）', '-' + comma(pension), 'minus') +
    row('貯蓄', '-' + comma(savingsCover), 'minus') +
    row('退職金（死亡退職金）', '-' + comma(retirementCover), 'minus') +
    row('カバー済み 合計', '-' + comma(totalCover), 'total-row minus') +
    '<tr style="background:var(--green-pale);font-weight:800;font-size:1.05rem"><td>必要保障額（不足額）</td><td style="text-align:right;color:var(--green-dark)">' + formatMoney(gap) + '</td></tr>';

  drawBarChart();
  drawPieChart();
}

function row(label, value, cls){
  var display = typeof value === 'string' ? value : comma(value);
  return '<tr class="'+(cls||'')+'"><td>'+label+'</td><td style="text-align:right">'+display+'</td></tr>';
}

function comma(n){
  if(typeof n === 'string') return n;
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function formatMoney(n){
  if(n >= 10000){
    return comma(Math.round(n / 10000 * 10) / 10) + '億円';
  }
  return comma(n) + '万円';
}

/* ===== Bar Chart (Canvas) ===== */
function drawBarChart(){
  var canvas = document.getElementById('barChart');
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var w = canvas.clientWidth;
  var h = canvas.clientHeight || 300;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  ctx.scale(dpr, dpr);
  ctx.clearRect(0,0,w,h);

  var data = [
    {label:'生活費', value: lastResult.livingNeed, color:'#2e7d32'},
    {label:'教育費', value: lastResult.eduNeed, color:'#43a047'},
    {label:'住居費', value: lastResult.housingNeed, color:'#1a3a5c'},
    {label:'葬儀費', value: lastResult.funeralNeed, color:'#2c5282'}
  ];

  var maxVal = 0;
  data.forEach(function(d){ if(d.value > maxVal) maxVal = d.value; });
  if(maxVal === 0) maxVal = 100;

  var padding = {top:20, right:20, bottom:55, left:65};
  var chartW = w - padding.left - padding.right;
  var chartH = h - padding.top - padding.bottom;
  var barW = Math.min(60, chartW / data.length * 0.6);
  var gap = (chartW - barW * data.length) / (data.length + 1);

  // Y axis
  ctx.strokeStyle = '#e0e0e0';
  ctx.fillStyle = '#999';
  ctx.font = '11px sans-serif';
  ctx.textAlign = 'right';
  var steps = 5;
  for(var i=0; i<=steps; i++){
    var yVal = Math.round(maxVal / steps * i);
    var yPos = padding.top + chartH - (chartH * yVal / maxVal);
    ctx.beginPath();
    ctx.moveTo(padding.left, yPos);
    ctx.lineTo(w - padding.right, yPos);
    ctx.stroke();
    ctx.fillText(comma(yVal) + '万', padding.left - 5, yPos + 4);
  }

  // Bars
  data.forEach(function(d, idx){
    var x = padding.left + gap + idx * (barW + gap);
    var barH = maxVal > 0 ? (d.value / maxVal) * chartH : 0;
    var y = padding.top + chartH - barH;

    // Bar with rounded top
    ctx.fillStyle = d.color;
    ctx.beginPath();
    var r = Math.min(6, barW/2);
    ctx.moveTo(x, padding.top + chartH);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.lineTo(x + barW - r, y);
    ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
    ctx.lineTo(x + barW, padding.top + chartH);
    ctx.closePath();
    ctx.fill();

    // Value label
    ctx.fillStyle = '#333';
    ctx.font = 'bold 11px sans-serif';
    ctx.textAlign = 'center';
    if(d.value > 0){
      ctx.fillText(comma(d.value) + '万', x + barW/2, y - 6);
    }

    // Category label
    ctx.fillStyle = '#555';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(d.label, x + barW/2, padding.top + chartH + 18);
  });
}

/* ===== Pie Chart (Canvas) ===== */
function drawPieChart(){
  var canvas = document.getElementById('pieChart');
  var ctx = canvas.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var w = canvas.clientWidth;
  var h = canvas.clientHeight || 300;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  ctx.scale(dpr, dpr);
  ctx.clearRect(0,0,w,h);

  var covered = lastResult.totalCover || 0;
  var gap = lastResult.gap || 0;
  var total = covered + gap;
  if(total === 0) total = 1;

  var slices = [
    {label:'カバー済み', value: covered, color:'#2e7d32'},
    {label:'不足額', value: gap, color:'#c62828'}
  ];

  var cx = w / 2;
  var cy = h / 2 - 15;
  var radius = Math.min(cx, cy) - 30;
  if(radius < 40) radius = 40;

  var startAngle = -Math.PI / 2;
  slices.forEach(function(s){
    var sliceAngle = (s.value / total) * Math.PI * 2;
    if(sliceAngle < 0.001 && s.value === 0) return;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radius, startAngle, startAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = s.color;
    ctx.fill();

    // Label
    if(s.value > 0){
      var midAngle = startAngle + sliceAngle / 2;
      var labelR = radius * 0.65;
      var lx = cx + Math.cos(midAngle) * labelR;
      var ly = cy + Math.sin(midAngle) * labelR;
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 12px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      var pct = Math.round(s.value / total * 100);
      ctx.fillText(pct + '%', lx, ly);
    }
    startAngle += sliceAngle;
  });

  // Center hole (donut)
  ctx.beginPath();
  ctx.arc(cx, cy, radius * 0.45, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  // Center text
  ctx.fillStyle = '#333';
  ctx.font = 'bold 13px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  var coverPct = Math.round(covered / (lastResult.totalNeed || 1) * 100);
  ctx.fillText('カバー率', cx, cy - 9);
  ctx.font = 'bold 18px sans-serif';
  ctx.fillStyle = covered >= (lastResult.totalNeed || 0) ? '#2e7d32' : '#c62828';
  ctx.fillText(Math.min(100, coverPct) + '%', cx, cy + 12);

  // Legend
  var legendY = h - 20;
  ctx.font = '12px sans-serif';
  slices.forEach(function(s, i){
    var lx = cx - 80 + i * 120;
    ctx.fillStyle = s.color;
    ctx.fillRect(lx, legendY - 5, 12, 12);
    ctx.fillStyle = '#333';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.fillText(s.label + ' ' + comma(s.value) + '万', lx + 16, legendY + 1);
  });
}

/* ===== Init ===== */
toggleHousingUI();
calc();

/* Resize handler for charts */
var resizeTimer;
window.addEventListener('resize', function(){
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(function(){ drawBarChart(); drawPieChart(); }, 150);
});

})();
</script>
</body>
</html>